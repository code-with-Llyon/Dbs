{% extends "base.html" %}
{% block content %}

<h2 class="mb-3">Upload Document</h2>

{# show flash messages from Flask #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, msg in messages %}
      <div
        class="alert alert-{{ category }} alert-dismissible fade show"
        role="alert"
      >
        {{ msg }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="row">
  <div class="col-md-6">
    <form id="uploadForm" method="POST" enctype="multipart/form-data">
      <div class="mb-3">
        <label class="form-label">Purpose</label>
        <select id="purpose" name="purpose" class="form-select" required>
          <option value="">-- Select Purpose --</option>
          <option value="study" {% if purpose == 'study' %}selected{% endif %}>Study</option>
          <option value="work" {% if purpose == 'work' %}selected{% endif %}>Work</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">Category</label>
        <select id="category" name="category" class="form-select" required>
          <option value="">-- Select Category --</option>
          {# options are filled by JS based on purpose #}
        </select>
      </div>

      {# This box shows the textual list of required docs #}
      <div id="requiredDocsBox" class="alert alert-info d-none"></div>

      {# This container will be filled by JS with one file input per required doc #}
      <div id="docsContainer" class="mt-3"></div>

      <button type="submit" class="btn btn-primary mt-3">Upload All Documents</button>
    </form>

    <div id="js-feedback" class="mt-3"></div>
  </div>

  <div class="col-md-6">
    <h4>Checklist</h4>

    {% if purpose and category %}
      <p>
        <strong>Purpose:</strong> {{ purpose|capitalize }}<br>
        <strong>Category:</strong> {{ category.replace('_', ' ')|title }}
      </p>
    {% endif %}

    {% if required_docs %}
      <ul class="list-group mb-3">
        {% for item in required_docs %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
              {{ item.doc_type.replace('_', ' ')|title }}
              {% if item.info and item.info.expiry %}
                <br>
                <small class="text-muted">Expiry: {{ item.info.expiry }}</small>
              {% endif %}
              {% if item.info and item.info.uploaded_at %}
                <br>
                <small class="text-muted">Uploaded at: {{ item.info.uploaded_at }}</small>
              {% endif %}
            </span>
            {% if item.uploaded %}
              <span class="badge bg-success rounded-pill">Uploaded</span>
            {% else %}
              <span class="badge bg-secondary rounded-pill">Missing</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>

      {% if all_ready %}
        <div class="alert alert-success">
          ðŸŽ‰ All required documents for this category have been uploaded.
        </div>
      {% else %}
        <div class="alert alert-warning">
          Some required documents are still missing. Please continue uploading.
        </div>
      {% endif %}
    {% else %}
      <p class="text-muted">
        Select a purpose and category, then start uploading documents.
      </p>
    {% endif %}
  </div>
</div>

<script src="{{ url_for('static', filename='js/validation.js') }}"></script>
{% endblock %}
